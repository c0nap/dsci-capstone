name: Update Docs Job
on:
  workflow_call:
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to see other branches

      - name: Install Doxygen, Graphviz, and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends doxygen graphviz \
            texlive-latex-base texlive-latex-recommended \
            texlive-latex-extra texlive-fonts-recommended make

      - name: Generate Doxygen documentation
        working-directory: docs
        run: doxygen

      # Carry docs/html and docs/latex over to the 'docs' branch
      - name: Stash generated files
        run: |
          mkdir -p /tmp/doxygen/html /tmp/doxygen/latex
          cp -r docs/html/* /tmp/doxygen/html/ || true
          cp -r docs/latex/* /tmp/doxygen/latex/ || true

      - name: Build PDF from LaTeX output
        working-directory: /tmp/doxygen/latex
        run: make
        continue-on-error: true

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Switch to docs branch
        run: |
          git fetch origin docs
          git switch docs

      - name: Clear existing files
        run: rm -rf ./*

      - name: Copy generated HTML and PDF
        run: |
          cp -r /tmp/doxygen/html/* ./ || true
          mkdir -p latex
          cp /tmp/doxygen/latex/refman.pdf latex/ || true

      - name: Insert "Download PDF" link into Doxygen homepage
        run: |
          if [ -f "index.html" ]; then
            sed -i "s|</body>|<p style='text-align:center;margin-top:2em;'><a href='latex/refman.pdf' style='font-weight:bold;'>ðŸ“„ Download Full Documentation (PDF)</a></p></body>|" "index.html"
          fi

      - name: Commit and push changes
        run: |
          git add .
          git commit -m "Auto-generate Doxygen HTML + PDF [skip ci]" || echo "No changes to commit"
          git push origin docs --force
