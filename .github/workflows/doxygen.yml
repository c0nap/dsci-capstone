name: Generate and Publish Doxygen Docs
on:
  workflow_call:


jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required to see other branches

      - name: Install Doxygen, Graphviz, and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz \
            texlive-latex-base texlive-latex-recommended \
            texlive-latex-extra texlive-fonts-recommended make

      - name: Generate Doxygen documentation
        working-directory: docs
        run: doxygen

      - name: Build PDF from LaTeX output
        working-directory: docs/latex
        run: make
        continue-on-error: true

      - name: Insert "Download PDF" link into Doxygen homepage
        run: |
          HTML_HOME="docs/html/index.html"
          PDF_PATH="latex/refman.pdf"
          if [ -f "$HTML_HOME" ]; then
            sed -i "s|</body>|<p style='text-align:center;margin-top:2em;'><a href='$PDF_PATH' style='font-weight:bold;'>ðŸ“„ Download Full Documentation (PDF)</a></p></body>|" "$HTML_HOME"
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Publish documentation to docs branch
        run: |
          git fetch origin docs
          git switch docs || git checkout -b docs origin/docs
          rm -rf ./*

          cp -r docs/html/* .
          mkdir -p latex
          cp -r docs/latex/refman.pdf latex/

          git add .
          git commit -m "Auto-generate Doxygen HTML + PDF [skip ci]" || echo "No changes to commit"
          git push origin docs --force

